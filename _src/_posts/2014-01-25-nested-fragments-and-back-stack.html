---
layout: post
title: Nested Fragments and the Back Stack
date: '2014-01-25T23:09:00.001+05:30'
author: Kiran Rao
tags:
- nested
- fragments
- programming
- backstack
- android
modified_time: '2014-02-09T19:48:46.557+05:30'
blogger_id: tag:blogger.com,1999:blog-1898571694993659507.post-7911924525568088009
blogger_orig_url: http://curioustechizen.blogspot.com/2014/01/nested-fragments-and-back-stack.html
---

<p>This article is not about the back stack of <em>activities</em> that Android maintains for every task. That stuff has been written about adequately elsewhere. This post is about the back stack of <em>fragment transactions</em> maintained by the <a href="http://developer.android.com/reference/android/support/v4/app/FragmentManager.html"><code>FragmentManager</code></a> and how they relate to nested fragments.</p> <p><strong>Edit: Other posts in this series at</strong></p><ol><li><a href="http://curioustechizen.blogspot.com/2014/02/nested-fragment-and-backstack-part-2.html">Part 2</a></li><li><a href="http://curioustechizen.blogspot.com/2014/02/nested-fragments-and-backstack-part-3.html">Part 3</a></li></ol> <p><strong>Heads-up:</strong> If you are using nested fragments, you need to use the support library, even if your app only targets API level 14 and above. This is because nested fragment support was <a href="http://developer.android.com/about/versions/android-4.2.html#NestedFragments">added in API 17</a>, and the feature was back-ported to the support library (revision 11 and later).</p> <h3 id="tldr">TL;DR</h3> <p>The gist of this post can be stated as follows:</p> <blockquote>  <p>There are many situations where a fragment may be mostly torn down (such as when placed on the back stack with no UI showing), but its <strong>state will not be saved until its owning activity actually needs to save its state</strong>.</p></blockquote> <p>This is from the <a href="http://developer.android.com/reference/android/support/v4/app/Fragment.html#onSaveInstanceState%28android.os.Bundle%29">docs</a> (emphasis mine). Overlooking this can lead to bugs especially when you use nested fragments since the back stack of a child fragment manager could be reset when you least expect it. Remember - if the state of a <code>Fragment</code> is not saved, then by definition, the back stack of fragment transactions managed by that fragment’s child <code>FragmentManager</code> is not saved either.</p> <h3 id="the-problem">The Problem</h3> <p>With the advent of fragments, more so nested fragments, the general advice one gets from the developer community is this:</p> <blockquote>  <p>Fragmentize all the everythings!</p></blockquote> <p>And with good reason too. Consider the following:</p> <ul><li>If you use ActionBar tabs, the content of each tab is implemented as a <code>Fragment</code>.</li><li>Each “page” in a <code>ViewPager</code> is often implemented as a <code>Fragment</code>.</li><li>In navigation drawers, the “content” of each navigation item is expected to be a <code>Fragment</code>.</li></ul> <p>What this translates to is that what would once be implemented as an <code>Activity</code> now needs to be implemented as a <code>Fragment</code>. This also means that a <em>flow within that <code>Activity</code></em>, that might have been implemented using <code>Fragment</code>s, now needs to be implemented using <strong>nested <code>Fragment</code>s</strong>. Note that by “flow” I simply mean a sequence of screens to establish a particular task.</p> <p>Now here’s the thing with flows: If a user “goes away” from a flow and later returns to it, it is expected that the user continues from the screen where they left off. Translated into <code>Fragment</code> terminology, this means that if a user navigates away and returns to a flow that is implemented using <code>Fragment</code>s, its is expected that the user’s position in the backstack of fragment transactions is retained. However, this isn’t always the case.</p> <p>Here is a video demonstrating the problem:</p> <iframe src="//www.youtube.com/embed/3gRq3hG9tS4" allowfullscreen="" frameborder="0" height="315" width="420"></iframe> <p>The video shows an <code>Activity</code> with three tabs. It is a modified version of an <code>Activity</code> created using the “New Activity” wizard in ADT or Android Studio and specifying “Fixed Tabs + Swipe” navigation. The modification is as follows:</p> <ul><li>The content of the first tab has been modified to make it a “Container” <code>Fragment</code> that in turn contains two nested fragments.</li><li>When the container fragment is first created, it shows a nested fragment asking you to enter your name.</li><li>On entering the name and Clicking “Next”, you are presented with another nested fragment asking you to enter your GitHub username.</li><li>The other two tabs are just simple <code>Fragment</code>s - no nesting business there.</li></ul> <p>Now, notice what happens when I follow this sequence:</p> <ol><li>Enter name, press Next. Then, enter a github username.</li><li>Navigate to the tab titled “Section 2” and then back to “Section 1”.</li><li>Navigate to the tab titled “Section 3” and then back to “Section 1”.</li></ol> <p>Uh! In step 3 above, the back stack was nuked. But hey, it didn’t happen in Step 2. Why so?</p> <h3 id="explanation">Explanation</h3> <p>This example uses a <code>ViewPager</code>. By default, a <code>ViewPager</code> has an “off screen limit” of 1. This means that in addition to the page being displayed, one adjacent page in each direction is kept in memory. So, when you navigate to “Section 2”, everything in “Section 1” is still intact in memory.</p> <p>When you navigate to “Section 3”, the page corresponding to “Section 1” is torn down. More importantly, since at this point the <code>Activity</code> instance state is not being saved, the <code>Fragment</code> state isn’t saved either. This ties in with what we saw in the “TL;DR” section above. As a result, when you navigate back to “Section 1”, the nested fragment back stack is reset.</p> <h3 id="rotation-task-switching">Rotation? Task Switching?</h3> <p>Try following this sequence of steps:</p> <ol><li>Enter name, press Next. Then, enter a github username.</li><li>Rotate the device; or switch to another app and return back to this app</li></ol> <p>Now you’ll see that the back stack is retained. This is because when you rotate the device or switch to another task, the Activity saves its instance state. As a consequence the container fragment does too.</p> <h3 id="conclusion">Conclusion</h3> <p>Re-iterating what we started off this post with, <strong>keep in mind when you are using nested fragments that a <code>Fragment</code> is guaranteed to save state only when the containing <code>Activity</code> saves its instance state. At other times, the <code>Fragment</code> might simply be torn down</strong>.</p> <p>The code for a sample app illustrating the problem is available <a href="https://github.com/curioustechizen/blog-nested-fragments-backstack">at github</a>. The next part of this series will explore ways to overcome this problem.</p>