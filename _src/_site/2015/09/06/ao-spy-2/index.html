<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en" class="no-js" prefix="og: http://ogp.me/ns#"> <!--<![endif]-->
  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta http-equiv="content-language" content="en" />
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

      
        <meta name="description" content="A place for discussing anything tech. Old and new. Experiences and Opinions. Questions and rants. Primarily programming-related, but not exclusively.">

      

      <title> AO(sp)y Episode 2 - Lambdas | Curious Techizen</title>
      
<link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300,700italic|Source+Code+Pro:400,700' rel='stylesheet' type='text/css'>
<link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">
      <link rel="stylesheet" type="text/css" href="/blog/css/main.css" />
      <link href="http://localhost:4000/blog/feed.xml" type="application/rss+xml" rel="alternate" title="RSS2.0">
      <link rel="shortcut icon" href="/blog/favicon.ico">

      
        


      

      <!-- Begin Jekyll SEO tag v2.1.0 -->
<title>AO(sp)y Episode 2 - Lambdas - Curious Techizen</title>
<meta property="og:title" content="AO(sp)y Episode 2 - Lambdas" />
<meta name="description" content="This post is the second episode in a series where I peek into random commits on AOSP and try to predict what’s coming to the world of Android development." />
<meta property="og:description" content="This post is the second episode in a series where I peek into random commits on AOSP and try to predict what’s coming to the world of Android development." />
<link rel="canonical" href="http://localhost:4000/blog/2015/09/06/ao-spy-2/" />
<meta property="og:url" content="http://localhost:4000/blog/2015/09/06/ao-spy-2/" />
<meta property="og:site_name" content="Curious Techizen" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-09-06T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@ki_run" />
<meta name="twitter:creator" content="@Kiran Rao" />
<meta name="google-site-verification" content="H8RGMD_f_siP2w-pSgSovLpeKIMac--hZGy47rZWoUM" />
<script type="application/ld+json">
{"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "AO(sp)y Episode 2 - Lambdas",
"datePublished": "2015-09-06T00:00:00+02:00",
"description": "This post is the second episode in a series where I peek into random commits on AOSP and try to predict what’s coming to the world of Android development.",
"url": "http://localhost:4000/blog/2015/09/06/ao-spy-2/"}</script>
<!-- End Jekyll SEO tag -->


  </head>

  <body>
    <!--[if lt IE 7]>
        <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

    <div class="off-canvas">
      <figure class="avatar">
        <img src="/blog/assets/img/avatar.jpg" alt="Picture" title="That's me, Kiran Rao.">
      </figure>
      <div class="bio">
          <h1>Hi, I'm Kiran Rao.</h1>
          <p>Android Developer. Tech enthusiast. Serial dabbler.</p>
      </div>
      <nav>
        <h6>Follow me on</h6>
        <ul>
          
          <li><a target="_blank" href="http://twitter.com/ki_run">Twitter</a></li>
          
          
          <li><a target="_blank" href="https://github.com/curioustechizen">Github</a></li>
          
          
          
          
          <li><a target="_blank" href="https://plus.google.com/116652261752707476836">Google+</a></li>
          
        </ul>
      </nav>
      <nav>
        <h6>Link</h6>
        <ul>
          <li><a href="/blog/">Home</a></li>
          <li><a href="/blog/tags/">Tags</a></li>
        </ul>
      </nav>
    </div>

    <div class="site-wrapper">

      <header>
        <div class="h-wrap">
          <h1 class="title"><a href="/blog/" title="Back to Homepage">Curious Techizen</a></h1>
          <a class="menu-icon" title="Open Bio"><span class="lines"></span></a>
        </div>
      </header>

      <main>
        <section class="single-wrap">
  <article class="single-content" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="feat">
      <h5 class="page-date">
        <time datetime="2015-09-06T00:00:00+02:00" itemprop="datePublished">
          06 September 2015
        </time>
      </h5>
    </div>
    <h1 class="page-title" itemprop="name headline">AO(sp)y Episode 2 - Lambdas</h1>
    <div itemprop="articleBody">
      <p>This post is the second episode in a series where I peek into random commits on AOSP and try to predict what’s coming to the world of Android development.</p>

<blockquote>
  <p>Disclaimer: These tidbits have been gleaned primarily from the commit messages on AOSP. I very rarely even read (let alone understand) the code. As such expect inaccuracies or downright mistakes here. Do not make decisions based on what you read in this post.</p>
</blockquote>

<p>That out of the way, let’s dig in. This episode was supposed to be about toolchain improvements, but the headline feature is what the title says - lambdas! Lest I am accused of clickbait, let me clarify that all of this is still experimental. Several commits are not even merged. There is no saying when (and if) any of these features will actually find their way into production.</p>

<p>Ever since Java8 was released, the clamor for using lambdas in Android development has been growing, with good reason too. Android is full of anonymous inner classes for all kinds of things and several of these use cases would benefit from the use of lambdas.</p>

<p>Java 8 brought about two types of enhancements to the Java programming language:</p>

<ol>
  <li>Features and syntax in the language itself</li>
  <li>Additions to the standard libraries to take advantage of the new features</li>
</ol>

<p>This article concentrates purely on the first type of enhancements, i.e.,</p>

<ul>
  <li><a href="http://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html">Lambdas</a></li>
  <li><a href="http://docs.oracle.com/javase/tutorial/java/javaOO/methodreferences.html">Method references</a></li>
  <li><a href="http://docs.oracle.com/javase/tutorial/java/IandI/defaultmethods.html">Default methods in interfaces</a></li>
  <li>Static methods in interfaces</li>
</ul>

<p>It does not look like there is any move to bring the enhancements to the runtime libraries in the form of new collections and <code class="highlighter-rouge">java.util.function</code> package to Android.</p>

<p>So, what’s cooking?</p>

<p>###Runtime support
Opcodes for creating and invoking lambdas are <a href="https://android-review.googlesource.com/#/c/147957/">being added</a> to the Dalvik bytecode (dex) format. The ART interpreter is <a href="https://android-review.googlesource.com/#/c/155661/">being updated</a> to be able to use these opcodes.</p>

<p>The first of these commits also points to the <code class="highlighter-rouge">dex2oat</code> compiler being taught how to compile lambdas from your dex bytecode into the corresponding opcodes for OAT.</p>

<p>What does all this mean? It means that <em>lambdas might be supported natively</em> in a future version of Android.</p>

<p>###Toolchain enhancements
<a href="https://android-review.googlesource.com/#/c/158285/">This commit</a> and related ones point to the possibility of Jack compiler doing basically what is achieved with <a href="https://github.com/evant/gradle-retrolambda">gradle-retrolambda</a> today. In other words, Jack compiler will be able to compile lambdas into bytecode that works even on runtimes that don’t support lambda opcodes. Similarly, Jill will likely do to lambdas in .class/.jar libraries what Jack does to them in source code.</p>

<p>###Other Java8 features
There’s more to Java8 than just the lambda syntax. AOSP also has commits that hint at support for <a href="https://android-review.googlesource.com/#/c/169003/">default methods</a> and <a href="https://android-review.googlesource.com/#/c/158165/">Single Abstract Methods</a>. I did not find any obvious mention of method references, but that might be because I’m not looking hard enough. In any case, method references are just syntax sugar for lambdas so if lambda expressions are supported, so should method references.</p>

<p>###Compatibility
At first glance, one might conclude that lambdas will be used only if <code class="highlighter-rouge">minSdkVersion &gt;=</code> the version of Android in which they are introduced, and that Jack’s feature of down-compiling lambdas into Java7-compatible bytecode will be used in all other cases. This means that the runtime lambdas will not be used <em>even on the runtimes that support them unless <code class="highlighter-rouge">minSdkVersion</code> is set to the latest</em>. However, this is (more than) likely to negatively impact the adoption of lambdas.</p>

<p>So, what might be strategies to work around this? What follows is a <strong>wild guess</strong> as to how this might pan out. I haven’t dug in the source code into much (or … <em>any</em>) detail (not that I’d understand much of it even if I had, but that’s beside the point).</p>

<p>Remember that <code class="highlighter-rouge">dex2oat</code> runs on the Android device. The APK file only has dex bytecode, and it is converted into OAT at installation time. Could this be used to enhance the compatibility story?</p>

<p>Jack might use <code class="highlighter-rouge">targetSdkVersion</code> to decide whether to include lambdas in the compiled dex bytecode. If <code class="highlighter-rouge">targetSdkVersion &gt;=</code> the version in which lambda support is introduced, then the generated dex might <em>include</em> the Java8 bytecode. But wait, aren’t we back at square one? <code class="highlighter-rouge">dex2oat</code> is part of the Android OS and cannot (yet) be updated independently of the OS. This means that <code class="highlighter-rouge">dex2oat</code> that is running on an older version of the OS will not understand the new dex bytecode.</p>

<p>This is why I say <em>include</em> Java8 opcodes instead of <em>generate</em> - that is to say, Jack might generate both the Java7-compatible byte code as well as new Java8 opcodes. Hopefully, <code class="highlighter-rouge">dex2oat</code> running on older versions of Android simply ignore the Java8 opcodes. But, what about the size implications of this arrangement? In lambda-heavy apps, will this result in bloated <code class="highlighter-rouge">.dex</code> files?</p>

<p>The other option is that Jack might always generate Java7 compatible bytecode (compiles lambda expressions into anonymous inner classes), but it might include some sort of flag to indicate to <code class="highlighter-rouge">dex2oat</code> that these constructs be compiled into the corresponding Java8 OAT format. But this begs the question - what, then, is the point of the new opcodes in <code class="highlighter-rouge">.dex</code> format at all?</p>

<p>I do not have the answers to these questions yet (nor does AOSP). But I’m sure the answers will reveal themselves in the days to come. If you are interested in this topic, you can follow the progress yourself at the following locations on AOSP:</p>

<ul>
  <li><a href="https://android-review.googlesource.com/#/q/project:platform/art">platform/art</a> project …</li>
  <li>… particularly, the <a href="https://android-review.googlesource.com/#/q/status:merged+project:platform/art+branch:master+topic:lambda_experimental">lambda_experimental</a> topic</li>
  <li><a href="https://android-review.googlesource.com/#/q/project:toolchain/jack">toolchain/jack</a> project</li>
  <li>Pay special attention to <a href="https://android-review.googlesource.com/#/q/status:open+project:toolchain/jack+branch:ub-jack-lang-dev">ub-jack-lang-dev</a> branch</li>
</ul>

    </div>
    
    <div class="page-tags">
      <ul>
        
        <li>
          
          <a href="/blog/tags/aosp">AOSP</a>
          
        </li>
        
        <li>
          
          <a href="/blog/tags/android">Android</a>
          
        </li>
        
        <li>
          
          <a href="/blog/tags/java8">Java 8</a>
          
        </li>
        
        <li>
          
          <a href="/blog/tags/lambda">Lambda</a>
          
        </li>
        
      </ul>
    </div>
    
    <h6 class="back-to-top"><a href="#top">Back to Top</a></h6>
    
      <a rel="next" href="/blog/2017/03/05/kotlin-coi/" id="next">
        <span class="nav-title nav-title-next">newer</span> &rarr;
      </a>
    
    
      <a rel="prev" href="/blog/2015/08/12/ao-spy-1/" id="prev">
        &larr; <span class="nav-title nav-title-prev">older</span>
      </a>
    
  </article>
   
       <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES * * */
            var disqus_shortname = 'kiranrao';
            
            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
       
</section>

      </main>

      <footer>
        <small>Powered by Jekyll - Theme: <a href="https://github.com/ogaclejapan/materi-for-jekyll">materi</a> - &copy; ogaclejapan</small>
      </footer>

    </div>
    

    <script src="/blog/js/main.js"></script>
    
    
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-66125769-1', 'kiranrao.in');
        ga('send', 'pageview');
      </script>
      <!-- Global site tag (gtag.js) - Google Analytics -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-6NSXY6WHWF"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-6NSXY6WHWF');
      </script>
    

  </body>
</html>
